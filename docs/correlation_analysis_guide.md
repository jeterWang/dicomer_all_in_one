# 相关性分析模块使用指南

## 📋 概述

相关性分析模块是DICOM All-in-One工具中的核心功能之一，专门用于分析医学影像之间的相关性。该模块支持多种输入格式，提供丰富的自定义选项，并生成专业的分析报告。

## 🎯 主要功能

### 支持的文件格式
- **NIfTI文件** (.nii, .nii.gz) - 推荐用于DRM分析
- **DICOM PET图像** - 支持目录批量加载
- **RTSS文件** - 用于定义感兴趣区域(ROI)

### 分析类型
1. **NIfTI相关性分析** - 直接比较两个NIfTI文件
2. **DICOM ROI相关性分析** - 基于RTSS定义的ROI区域分析

## 🚀 快速开始

### 方法1: GUI界面操作

#### NIfTI文件分析
1. 启动应用程序：`uv run python main.py`
2. 切换到 **"NIfTI相关性分析"** 标签页
3. 按照以下步骤操作：

**步骤1: 加载文件**
- 点击"选择第一个NIfTI文件"，选择 `data/drm_data/DRM.nii.gz`
- 点击"选择第二个NIfTI文件"，选择 `data/drm_data/targetDRM.nii.gz`

**步骤2: 选择分析选项**
- 掩码选项：推荐选择"两个图像都非零的像素"（获得最高相关性）
- 阈值：默认0.1（仅在选择阈值掩码时使用）

**步骤3: 自定义选项**
- 图表标题：例如 "DRM vs Target DRM 相关性分析"
- X轴标签：例如 "DRM 像素值"
- Y轴标签：例如 "Target DRM 像素值"
- 输出文件前缀：例如 "DRM_analysis"

**步骤4: 执行分析**
- 选择输出目录（或使用默认目录）
- 点击"分析NIfTI相关性"按钮

#### DICOM PET分析
1. 切换到 **"相关性分析"** 标签页
2. 加载两个PET图像目录和RTSS文件
3. 选择ROI和自定义选项
4. 执行分析

### 方法2: 命令行脚本

```bash
# 完整测试（包含4种掩码选项）
uv run python test_nifti_correlation.py

# 快速测试（仅最佳选项）
uv run python quick_nifti_test.py

# 自定义选项测试
uv run python test_custom_nifti_analysis.py
```

## 📊 分析结果解读

### 相关系数含义
- **Pearson相关系数 (r)**：衡量线性相关性
  - r > 0.7：强正相关
  - 0.3 < r < 0.7：中等正相关
  - r < 0.3：弱相关
- **Spearman相关系数 (ρ)**：衡量单调相关性
- **p值**：统计显著性，p < 0.05表示显著相关

### DRM vs targetDRM 分析结果
根据测试结果，两个DRM文件的相关性分析显示：

| 掩码选项 | Pearson r | Spearman r | 像素数 | 推荐度 |
|---------|-----------|------------|--------|--------|
| 两个图像都非零的像素 | **0.6136** | **0.5889** | 312 | ⭐⭐⭐⭐⭐ |
| 第一个图像的所有非零像素 | -0.0107 | -0.0950 | 486 | ⭐ |
| 第一个图像的所有正值像素 | -0.0107 | -0.0950 | 486 | ⭐ |
| 第一个图像超过阈值的像素 | -0.0149 | -0.0960 | 468 | ⭐ |

**结论**: 使用"两个图像都非零的像素"掩码获得最佳结果，显示**中等偏强的正相关关系**。

## 📁 输出文件

每次分析生成以下文件：

### CSV数据文件
- **文件名格式**: `{前缀}_{掩码类型}_{时间戳}.csv`
- **内容**: 包含所有像素值对，便于进一步统计分析
- **格式**: 两列数据（Image1, Image2）

### 散点图
- **文件名格式**: `{前缀}_{掩码类型}_{时间戳}.png`
- **内容**: 高分辨率散点图，包含：
  - 数据点分布
  - 回归线
  - 相关系数和p值
  - 自定义标题和轴标签

### 示例输出文件名
```
DRM_analysis_两个图像都非零的像素_20250629_205422.csv
DRM_analysis_两个图像都非零的像素_20250629_205423.png
```

## ⚙️ 高级功能

### 自定义选项详解

#### 图表标题
- 用途：设置散点图的主标题
- 示例：
  - "DRM vs Target DRM 相关性分析"
  - "医学影像相关性分析"
  - "Image Correlation Analysis"

#### 轴标签
- X轴标签：描述第一个图像
- Y轴标签：描述第二个图像
- 示例：
  - "DRM 像素值" / "Target DRM 像素值"
  - "原始影像强度" / "目标影像强度"
  - "Image A" / "Image B"

#### 输出文件前缀
- 用途：自定义输出文件的命名前缀
- 示例：
  - "DRM_analysis"
  - "medical_analysis"
  - "correlation_study"

### 掩码选项说明

1. **两个图像都非零的像素** ⭐推荐
   - 只分析两个图像中都有有效数据的区域
   - 避免背景噪声干扰
   - 通常获得最可靠的相关性结果

2. **第一个图像的所有非零像素**
   - 以第一个图像为基准
   - 包含第一个图像的所有有效区域

3. **第一个图像的所有正值像素**
   - 只考虑第一个图像中的正值
   - 适用于某些特殊分析需求

4. **第一个图像超过阈值的像素**
   - 可调节阈值（默认0.1）
   - 过滤低强度区域

## 🔧 技术特性

### 图像处理能力
- **自动重采样**: 处理不同尺寸的图像
- **数据清理**: 自动移除NaN和无穷值
- **多种掩码**: 4种像素选择策略

### 统计分析
- **双重相关性**: Pearson + Spearman
- **显著性检验**: 自动计算p值
- **回归分析**: 线性拟合和R²值

### 输出质量
- **高分辨率图像**: 300 DPI输出
- **专业格式**: 包含完整统计信息
- **自定义样式**: 支持个性化标题和标签

## 📝 最佳实践

1. **文件准备**
   - 确保图像已正确配准
   - 检查图像方向和坐标系
   - 验证数据完整性

2. **掩码选择**
   - 优先使用"两个图像都非零的像素"
   - 根据具体需求调整阈值
   - 注意像素数量的合理性

3. **结果解读**
   - 关注相关系数的大小和方向
   - 检查p值的统计显著性
   - 结合散点图观察数据分布

4. **自定义设置**
   - 使用有意义的标题和标签
   - 选择合适的输出文件前缀
   - 保持命名的一致性

## 🚨 注意事项

1. **数据质量**
   - 确保图像质量良好
   - 避免过多的噪声和伪影
   - 检查图像的动态范围

2. **统计要求**
   - 需要至少5个有效像素点
   - 数据应有足够的变异性
   - 避免常数值区域

3. **结果验证**
   - 检查散点图的数据分布
   - 验证相关系数的合理性
   - 考虑生物学或物理学意义

## 📞 技术支持

如遇到问题，请检查：
1. 文件路径是否正确
2. 图像格式是否支持
3. 输出目录是否有写入权限
4. 日志信息中的错误提示

更多技术细节请参考源代码注释和日志输出。
