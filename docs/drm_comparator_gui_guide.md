# DRM比较器GUI使用指南

## 📋 概述

DRM比较器GUI是一个完整的图形界面工具，用于执行DRM图像的配准、变换和重采样操作。该模块已完全集成到DICOM All-in-One工具的主窗口中。

## 🚀 快速开始

### 启动应用程序
```bash
uv run python main.py
```

### 访问DRM比较器
1. 启动应用程序后，在主窗口中找到 **"DRM比较器"** 标签页
2. 点击切换到该标签页

## 🎯 主要功能

### 1. **完整的变换流程**
- 刚体变换 + DVF变换 + 目标空间重采样
- 支持直接重采样到目标空间（推荐）
- 支持传统分步重采样（调试用）

### 2. **方法比较**
- 自动比较两种重采样方法的差异
- 生成详细的统计分析报告
- 输出差异图像用于质量评估

### 3. **用户友好界面**
- 分步骤的文件加载流程
- 实时进度显示和状态更新
- 详细的操作日志记录

## 📝 使用步骤

### 步骤1: 加载输入文件

#### 必需文件：
1. **NIfTI图像** (.nii, .nii.gz)
   - 点击"选择NIfTI图像"按钮
   - 选择要变换的原始DRM图像

2. **刚体变换** (.dcm)
   - 点击"选择刚体变换"按钮
   - 选择DICOM格式的刚体变换文件

3. **DVF变换** (.dcm)
   - 点击"选择DVF变换"按钮
   - 选择DICOM格式的形变矢量场文件

4. **目标图像** (.nii, .nii.gz)
   - 点击"选择目标图像"按钮
   - 选择定义目标空间的参考图像

### 步骤2: 变换选项

#### 重采样方法选择：
- **直接重采样到目标空间（推荐）** ⭐
  - 优势：单次插值，减少累积误差
  - 适用：生产环境，追求最高精度
  
- **传统分步重采样（调试用）**
  - 优势：可以检查中间结果
  - 适用：调试、质量控制、方法验证

#### 输出设置：
- **输出目录**：选择结果保存位置
- **输出文件前缀**：自定义输出文件名前缀

### 步骤3: 执行操作

#### 主要操作：
1. **应用变换**
   - 执行完整的变换流程
   - 生成变换后的DRM图像

2. **比较重采样方法**
   - 同时执行两种重采样方法
   - 生成详细的比较报告

3. **保存结果**
   - 将变换结果保存为NIfTI文件
   - 支持自定义文件名和路径

## 🔧 高级功能

### 方法比较分析

当执行"比较重采样方法"时，系统会：

1. **执行两种方法**
   - 直接重采样到目标空间
   - 传统分步重采样

2. **生成比较文件**
   ```
   method_comparison/
   ├── direct_method_result.nii.gz      # 直接方法结果
   ├── traditional_method_result.nii.gz # 传统方法结果
   └── difference_image.nii.gz          # 差异图像
   ```

3. **统计分析报告**
   ```
   📊 重采样方法比较结果:
   ✅ 直接重采样: 成功
   ✅ 传统重采样: 成功
   
   📈 差异统计:
   - 最大绝对差异: 0.001234
   - 平均绝对差异: 0.000567
   - 差异标准差: 0.000890
   - 最大相对差异: 0.123%
   ```

### 实时监控

#### 进度显示：
- **进度条**：显示当前操作进度
- **状态标签**：实时更新操作状态
- **日志区域**：详细记录所有操作步骤

#### 状态信息：
- 文件加载状态
- 变换执行进度
- 错误和警告信息
- 成功完成确认

## 📊 输出文件

### 标准输出：
- **变换结果**: `{前缀}_{时间戳}.nii.gz`
- **空间信息**: 与目标图像完全匹配
- **数据类型**: 保持原始图像的像素类型

### 比较分析输出：
- **直接方法结果**: `direct_method_result.nii.gz`
- **传统方法结果**: `traditional_method_result.nii.gz`
- **差异图像**: `difference_image.nii.gz`
- **统计报告**: 在日志中显示

## ⚠️ 注意事项

### 文件要求：
1. **空间一致性**: 确保所有DICOM变换文件来自同一配准过程
2. **文件完整性**: 检查所有输入文件是否完整且可读
3. **坐标系统**: 确保图像使用一致的坐标系统

### 性能考虑：
1. **内存使用**: 大图像可能需要较多内存
2. **处理时间**: DVF变换可能需要较长时间
3. **磁盘空间**: 确保输出目录有足够空间

### 错误处理：
1. **文件加载失败**: 检查文件路径和格式
2. **变换失败**: 检查变换文件的有效性
3. **内存不足**: 考虑使用较小的图像或增加内存

## 🎯 最佳实践

### 1. **工作流程建议**
```
1. 准备所有输入文件
2. 使用直接重采样方法执行变换
3. 检查结果的空间信息是否正确
4. 如需验证，执行方法比较分析
5. 保存最终结果
```

### 2. **质量控制**
- 使用方法比较功能验证结果一致性
- 检查差异图像确认变换质量
- 验证输出图像的空间参数

### 3. **文件管理**
- 使用有意义的输出文件前缀
- 组织输出文件到专门的目录
- 保留原始文件作为备份

## 🔗 与其他模块的集成

### 相关性分析：
变换后的DRM图像可以直接用于：
- **NIfTI相关性分析**模块
- 与目标DRM图像进行相关性比较
- 评估配准和变换的质量

### 工作流程示例：
```
1. DRM比较器: 变换DRM到目标空间
2. 相关性分析: 分析变换后DRM与目标DRM的相关性
3. 结果评估: 基于相关性结果评估变换质量
```

## 📞 故障排除

### 常见问题：

**Q: 按钮无法点击？**
A: 确保所有必需文件都已加载

**Q: 变换失败？**
A: 检查DICOM变换文件的格式和完整性

**Q: 结果空间信息不匹配？**
A: 验证目标图像文件是否正确

**Q: 处理速度慢？**
A: 这是正常现象，DVF变换需要较长时间

### 日志信息：
- 查看日志区域获取详细错误信息
- 所有操作都有时间戳记录
- 成功和失败都有明确提示

## 🎉 总结

DRM比较器GUI提供了：

1. **✅ 完整功能**: 从文件加载到结果保存的完整流程
2. **✅ 优化算法**: 直接重采样减少插值误差
3. **✅ 质量控制**: 方法比较和差异分析
4. **✅ 用户友好**: 直观的界面和详细的反馈
5. **✅ 集成设计**: 与其他模块无缝配合

现在您可以在主窗口的"DRM比较器"标签页中享受完整的DRM图像处理功能！
